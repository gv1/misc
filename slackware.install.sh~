###################################################################
# Script for installing Slackware packages in the distribution
# Portions of this script are taken and modifed from /usr/lib/setup directory 
# in slackware installer
#
#
#
#
# Sep 2014


# check /usr/lib/setup/setup, slackinstall
set -e  # exit on error
SLVERSION=14.1
SRCDIR=$HOME/slackware-$SLVERSION/slackware
SERIES="a l ap n d e x xap xfce" 
TGT_PARTITION=
ROOTDIR=/mnt
FORMAT=

####
TAGFILE="-tagfile $HOME/slackware-$SLVERSION/tagfiles/$series/tagfile"
#tagfile sample entries from slackware/a/tagfile
# vboot-utils: ADD
# which:REC
# xfsprogs:OPT

# INFOBOX=-infobox
print_usage() {
    # usage
    echo "$0 "
    echo "-s --src"
    echo "-t --target"
    echo "-d --device"
    echo "-i --series"
    echo "-f --format"
}

print_setup() {
    echo "Installer source :  $SRCDIR"
    echo "Slackware version : SLVERSION=14.1"
    echo "Packeges directory : $SRCDIR"
    echo "Series : $SERIES"
    echo "Target Partition : $TGT_PARTITION"
    echo "Installion root : $ROOTDIR"
}
process_error() {
    if [ $1 == 99 ]; then
	echo "User abort installation, exiting"
	exit 1
    else
	echo "installpkg error #$1" --msgbox \
	    "There was a fatal error attempting to install $2.  The package may \
be corrupt, the installation media may be bad, one of the target \
drives may be full, or something else \
has caused the package to be unable to be read without error.  You \
may hit enter to continue if you wish, but if this is an important \
required package then your installation may not work as-is."
    fi
}

format_target() {
   if [ x$FORMAT = x"" ]; then


   else 
	case FORMAT 		

   fi	
}

preinstall_setup() {
    format_target
    mountpoint $ROOTDIR && umount $ROOTDIR
    mount $TGT_PARTITION $ROOTDIR
    echo "Installing Slackware from $SRCDIR to $TGT_PARTITION mounted on $ROOTDIR"
    echo "All packages in $SERIES will be installed"
    echo "Check $ROOTDIR/tmp/installpkg-report.log for instllation log"
    echo "Please remember to run setup for post installation configuration"
    test -d $ROOTDIR/tmp/ || mkdir $ROOTDIR/tmp
}

installall() {
    for series in $SERIES; do
	for package in $SRCPATH/$series/*.t?z ; do
	    echo "installpkg -root $ROOTDIR $TAGFILE $INFOBOX -priority ADD $package  2>> $ROOTDIR/tmp/installpkg-report.log"
	    ERROR=$?
	    if [ ! $ERROR = 0 ]; then
		process_error $ERROR $package
	    fi
	done
    done
}

# Process command line:
if [ $# -gt 0 ]; then # there are arguments to the command
  while [ $# -gt 0 ]; do
   case "$1" in
       "--src")
	   SRCDIR=`echo $2`
	   shift 2 
	   ;;
       "--target")
	   ROOTDIR=`echo $2`
	   shift 2 
	   ;;
       "--device")
	   TGT_PARTITION=`echo $2`
	   shift 2 
	   ;;
       "--series")
	   SERIES=`echo $2`
	   shift 2 
	   ;;
       "--config")
	   CONFIG=`echo $2`
	   shift 2 
	   ;;
       "--format")
	   FORMAT="echo $2`
	   ;;
       "--help")
	   print_usage 
	   ;;
   *)
     echo "Unrecognized option $1" ; shift 1
     print_usage
   esac
  done
else
    print_usage
    exit 1;
fi

#
if [ x$TGT_PARTITION = x"" ]; then
    echo "You must atleast provide target partition"
    print_usage
    exit 1
fi
print_setup
# preinstall_setup
installall


